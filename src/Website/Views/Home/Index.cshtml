@{
  ViewBag.Title = Strings.DashboardTitle;
}
<div class="row">
  <div class="col-xs-12 col-md-8 col-md-offset-2">
    <div class="panel panel-default">
      <div class="form-inline panel-body">
        @*<div class="form-group pull-left">
            <select data-bind="selectPickerOptions: events, selectPickerDataProps: { icon: 'foo' }, optionsText: 'name' , value: currentEvent" class="selectpicker"></select>
          </div>*@
        <button type="button" class="btn btn-sm btn-primary" data-bind="click: createEvent">New Event</button>
        <div class="form-group pull-right">
          <label>Show:</label>
          <button type="button" class="btn btn-sm btn-primary" data-bind="toggle: showRoster, css: { active: showRoster }" autocomplete="off">Roster</button>
          <button type="button" class="btn btn-sm btn-primary" data-bind="toggle: showCalls, css: { active: showCalls }" autocomplete="off">Call Log</button>
        </div>
      </div>
    </div>

    <div data-bind="visible: unassignedEvent.roster().length" style="display:none">
      <div data-bind="template: { name: 'roster-table-template', data: unassignedEvent}"></div>
    </div>
    <div data-bind="visible: showRoster, foreach: events" style="display: none">
      <div data-bind="template: { name: 'roster-table-template', data: $data }"></div>
    </div>
  </div>
</div>
<div class="row" data-bind="visible: showCalls" style="display:none">
  <div class="col-xs-12">
    <div class="panel panel-primary">
      <div class="panel-heading">Call Log</div>
      <table class="table table-striped table-condensed">
        <thead>
          <tr>
            <th style="width:1em" data-bind="sort: { arr: calls, prop: 'time', default: true}">Time</th>
            <th data-bind="sort: { arr: calls, prop: 'name'}">Name</th>
            <th data-bind="sort: { arr: calls, prop: 'number'}" class="hidden-xs">Number</th>
            @*<th data-bind="sort: { arr: roster, prop: 'hours'}" class=" text-right hidden-xs">Hours</th>
              <th data-bind="sort: { arr: roster, prop: 'miles'}" class=" text-right hidden-xs">Miles</th>*@
            <th class="hidden-xs">Message</th>
          </tr>
        </thead>
        <!-- ko if: (calls().length > 0) -->
        <tbody data-bind="foreachWithHighlight: { data: calls, duration: 3000}">
          <tr>
            <td class="text-right" style="width:1em; white-space:nowrap" data-bind="text: timeText"></td>
            <td><strong data-bind="text: name"></strong></td>
            <td class="hidden-xs"><a data-bind="text: number, attr: {href: 'tel:' + number }"></a></td>
            <td data-bind="if: recording" class="hidden-xs">
              <audio data-bind="attr: { src: recording }" controls="controls" />
            </td>
          </tr>
        </tbody>
        <!-- /ko -->
        <!-- ko if: (calls().length == 0) -->
        <tbody><tr><td colspan="3">No calls</td></tr></tbody>
        <!-- /ko -->
      </table>
    </div>
  </div>
</div>

@section scripts {
  <script type="text/html" id="roster-table-template">
    <div class="panel" data-bind="visible: $root.showRoster, css: $root.getRosterClass($data)">
      <div class="panel-heading">
        <!-- ko if: isUnassignedEvent -->
        <span class="fa fa-ban"></span>
        <!-- /ko -->
        <!-- ko if: !isUnassignedEvent -->
        <div class="btn-group">
          <button type="button" class="btn btn-sm btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
            <span class="fa fa-fw" data-bind="css: { 'fa-ban': closed, 'fa-bullhorn': !closed }"></span> <span class="caret"></span>
          </button>
          <ul class="dropdown-menu" role="menu">
            <li data-bind="click: $root.startClose"><button type="button" class="btn-link"><span class="fa fa-fw fa-ban"></span> Close ...</button></li>
            <li data-bind="click: $root.startMerge"><button type="button" class="btn-link"><span class="fa fa-fw fa-code-fork fa-rotate-180"></span> Merge into ...</button></li>
          </ul>
        </div>
        <!-- /ko -->
        Roster :: <span data-bind="text: name"></span>
      </div>
      <table class="table table-striped table-condensed">
        <thead>
          <tr>
            <th style="width:3%"></th>
            <th style="width:16%" data-bind="sort: { arr: $root.roster, prop: 'timeIn'}">Time In</th>
            <th style="width:40%" data-bind="sort: { arr: $root.roster, prop: 'name'}">Name</th>
            <th style="width:16%" data-bind="sort: { arr: $root.roster, prop: 'timeOutSort', default: true}">Time Out</th>
            <th style="width:13%" data-bind="sort: { arr: $root.roster, prop: 'hours'}" class=" text-right hidden-xs">Hours</th>
            <th style="width:12%" data-bind="sort: { arr: $root.roster, prop: 'miles'}" class=" text-right hidden-xs">Miles</th>
          </tr>
        </thead>
        <!-- ko if: (roster().length > 0) -->
        <tbody data-bind="foreachWithHighlight: { data: roster, duration: 3000}">
          <tr>
            <td class="roster" data-bind="css: state"></td>
            <td data-bind="text: timeIn.fromNow()"></td>
            <td><strong data-bind="text: name, conditionalLink: { test: isMember, value: '@(ViewBag.LinkTemplate)'.replace('{0}', memberId) }"></strong></td>
            <td data-bind="text: timeOutText"></td>
            <td class="text-right hidden-xs" data-bind="text: hours"></td>
            <td class="text-right hidden-xs" data-bind="text: miles"></td>
          </tr>
        </tbody>
        <!-- /ko -->
        @*<!-- ko if: (roster().length == 0) -->
          <tbody><tr><td colspan="6">No calls</td></tr></tbody>
          <!-- /ko -->*@
        <tfoot>
          <tr><th></th><th colspan="5"><span data-bind="text: roster().length">0</span> responders</th></tr>
        </tfoot>
      </table>
    </div>
  </script>
  <script type="text/html" id="edit-dialog-template">
    <div data-bind="with:editingEvent">
      <div class="form-group" data-bind="css: { 'has-error': name.error() }">
        <label>Title: <input type="text" data-bind="value: name" class="form-control" /></label>
        <span class="help-block" data-bind="text: name.error()"></span>
      </div>
      <div class="form-group">
        <label>Opened Date: <input type="text" data-bind="value: opened.date" class="form-control" /></label>
        <label>Opened Time: <input type="text" data-bind="value: opened.time" class="form-control" /></label>
      </div>
      <div data-bind="text: ko.toJSON($data)"></div>
      <div data-bind="text: ko.toJSON(opened.isValid)"></div>
    </div>
  </script>
  <script type="text/html" id="merge-dialog-template">
    <p>This form will allow you to merge event &quot;<strong data-bind="text: fromEvent.name()"></strong>&quot; into another existing event.</p>
    <div class="form-inline">
      <div class="form-group">
        <label>Merge Into: <select class="form-control" data-bind="options: availableEvents, optionsText: 'name', value: targetEvent"></select></label>
      </div>
    </div>
  </script>
  @Scripts.Render("~/bundles/page/index")
}
